platforms:
  - name: StandaloneWindows64
    type: Unity::VM::GPU
    image: sdet/gamecode_win10:stable
    flavor: b1.large
    components:
      - editor
      - il2cpp
projects:
  - name: URP_Performance
    folder: URP_Performance
suites:
  - mode: playmode
    filter: Counters
    platforms: [PS4]
  - mode: playmode
    filter: Memory
    platforms: [StandaloneWindows64]
  - mode: Editor
    filter: Build
    platforms: [StandaloneWindows64]
  - mode: Editor
    filter: StaticAnalysis
    platforms: [PS4]
---
{% for project in projects %}
{% for suite in suites %}
{% for platform in platforms %}

{% for allowed_platform in suite.platforms %}
{% if allowed_platform == platform.name %}

{{ project.name }}_{{ suite.filter }}_{{ platform.name }}:
  variables:
    EDITOR_VERSION: trunk
  name : Run {{ suite.filter }} Performance on {{ platform.name }}
  agent:
    type: {{ platform.type }}
    image: {{ platform.image }}
    flavor: {{ platform.flavor}}
  commands:
      {% if platform.setup %}
      - '{{ platform.setup }}'
      {% endif %}
      - pip install unity-downloader-cli --extra-index-url https://artifactory.internal.unity3d.com/api/pypi/common-python/simple --pre --upgrade
      - unity-downloader-cli -u %EDITOR_VERSION% {% for component in platform.components %}-c {{ component }} {% endfor %} --wait
      - git config --system core.longpaths true
      - git clone git@github.cds.internal.unity3d.com:unity/utr.git utr
      {% if 'CUSTOM-REVISION' != master %}
      - cd .\Graphics\ && git checkout master && cd ..
      {% endif %}
      - mklink /J C:\Link .\Graphics
      - NetSh Advfirewall set allprofiles state off
      - utr/utr --timeout=2400 --loglevel=verbose --scripting-backend=Il2Cpp --suite={{ suite.mode }} --testfilter={{ suite.filter }} --platform={{ platform.name }} --testproject=C:/Link/TestProjects/{{ project.folder }} --editor-location=.Editor --performance-project-version=./Graphics --report-performance-data --performance-project-id=HDRP --artifacts_path=test-results --player-connection-ip=%BOKKEN_HOST_IP%
  artifacts:
    logs:
      paths:
        - PrebuildLog/**
    results:
      paths:
        - "**/test-results/**/*"
        - "**/test-results/PerformanceTestReport.html"

{% endif %}
{% endfor %}
{% endfor %}
{% endfor %}
{% endfor %}